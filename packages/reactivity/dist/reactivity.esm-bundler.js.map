{"version":3,"file":"reactivity.esm-bundler.js","sources":["../../shared/src/index.ts","../src/effect.ts","../src/baseHandler.ts","../src/reactive.ts"],"sourcesContent":["// 判断是不是对象\nexport const isObject = (data: any) =>\n  typeof data === \"object\" && data !== null;\n\n// 判断是否改变\nexport const hasChanged = (oldValue: any, newValue: any) =>\n  !Object.is(oldValue, newValue);\n\n// 判断是否是数组\nexport const isArray = Array.isArray;\n\n// 对象合并\nexport const assign = Object.assign;\n\n// 判断是不是整数字符串\nexport const isIntegerKey = (key: any) => parseInt(key) + \"\" === key;\n\n// 判断是不是对象本身的属性\nexport const hasOwn = (target: any, key: any) =>\n  Object.prototype.hasOwnProperty.call(target, key);\n","import { isArray, isIntegerKey } from \"@vue/shared\";\n\nexport function effect<T = any>(fn: () => T, options: any = {}) {\n  const effect = createReactiveEffect(fn, options);\n  if (!options.lazy) {\n    effect();\n  }\n\n  return effect;\n}\nconst effectStack: any[] = [];\nlet activeEffect: any;\nfunction createReactiveEffect<T = any>(fn: () => T, options?: any) {\n  //   debugger;\n  const effect: any = function reactiveEffect() {\n    try {\n      effectStack.push(effect);\n      activeEffect = effect;\n      return fn();\n    } finally {\n      effectStack.pop();\n      activeEffect = effectStack[effectStack.length - 1];\n    }\n  };\n  effect._isEffect = true;\n  effect.options = options;\n  effect.deps = [];\n  return effect;\n}\nconst targetMap = new WeakMap();\nexport const track = (target: any, type: string, key: any) => {\n  if (activeEffect === undefined) {\n    return;\n  }\n\n  let depsMap = targetMap.get(target);\n  if (!depsMap) {\n    targetMap.set(target, (depsMap = new Map()));\n  }\n\n  let dep = depsMap.get(key);\n  if (!dep) {\n    depsMap.set(key, (dep = new Set()));\n  }\n\n  if (!dep.has(activeEffect)) {\n    dep.add(activeEffect);\n  }\n};\n\nexport const trigger = (\n  target: any,\n  type: string,\n  key: any,\n  newVal: any,\n  oldVal?: any\n) => {\n  const depsMap = targetMap.get(target);\n  if (!depsMap) {\n    return;\n  }\n\n  const effectSet = new Set();\n  const add = (effects: any) => {\n    if (effects) {\n      effects.forEach((effect: any) => {\n        effectSet.add(effect);\n      });\n    }\n  };\n\n  if (key === \"length\" && isArray(target)) {\n    depsMap.forEach((dep: any, key: any) => {\n      console.log(\"depKey\", dep, key);\n      if (key > newVal || key === \"length\") {\n        add(dep);\n      }\n    });\n  } else {\n    add(depsMap.get(key));\n    switch (type) {\n      case \"add\":\n        if (isArray(target) && isIntegerKey(key)) {\n          add(depsMap.get(\"length\"));\n        }\n    }\n  }\n\n  effectSet.forEach((effect: any) => effect());\n};\n","import {\n  assign,\n  hasChanged,\n  hasOwn,\n  isArray,\n  isIntegerKey,\n  isObject,\n} from \"@vue/shared\";\nimport { track, trigger } from \"./effect\";\nimport { reactive, readonly } from \"./reactive\";\n\n/**\n *\n * @param isReadonly 是不是仅读的\n * @param isShallow 是不是浅的\n */\n// 创建 getter\nconst createGetter = (\n  isReadonly: boolean = false,\n  isShallow: boolean = false\n) => {\n  /**\n   * target 源对象\n   * key 建\n   * receiver 代理对象\n   */\n  return function get(target: object, key: string, receiver: object) {\n    const res = Reflect.get(target, key, receiver);\n    if (isShallow) return res;\n    // 如果不是只读就进行依赖收集\n    if (!isReadonly) {\n      // console.log(\"收集依赖\");\n      track(target, \"get\", key);\n    }\n    if (isObject(res)) return isReadonly ? readonly(res) : reactive(res);\n    return res;\n  };\n};\n\n// 既不是仅读的也不是浅的 get\nconst get = createGetter();\n// 不是仅读的但是是浅的 get\nconst shallowGet = createGetter(false, true);\n// 是仅读的但不是浅的 get\nconst readonlyGet = createGetter(true);\n// 即是仅读的也是浅的 get\nconst shallowReadonlyGet = createGetter(true, true);\n\n/**\n *\n * @param isReadonly 是不是仅读的\n * @param isShallow 是不是浅的\n */\n// 创建 setter\nconst createSetter = (\n  isReadonly: boolean = false,\n  isShallow: boolean = false\n) => {\n  /**\n   * target 源对象\n   * key 建\n   * value 新值\n   * receiver 代理的对象\n   */\n  // 针对数组而言，如果调用 push 方法，就会触发两次 set，一次为数组新增了一项，一次改变数组的长度，\n  // 但是再为数组新增一项的时候就同时修改了数组的长度了，所以第二次调用是没有意义的\n  return function set(\n    target: object,\n    key: string,\n    value: any,\n    receiver: object\n  ) {\n    const oldVal = (target as any)[key];\n    const hadKey =\n      isArray(target) && isIntegerKey(key)\n        ? Number(key) < target.length\n        : hasOwn(target, key);\n    const res = Reflect.set(target, key, value, receiver);\n    if (!hadKey) {\n      console.log(\"新增\");\n      trigger(target, \"add\", key, value);\n    } else if (hasChanged(oldVal, value)) {\n      console.log(\"修改\");\n      trigger(target, \"set\", key, value, oldVal);\n    }\n    // console.log(\"设置值\", target, key, value);\n    return res;\n  };\n};\n\n// 既不是仅读的也不是浅的 set\nconst set = createSetter();\n// 不是仅读的但是是浅的 set\nconst shallowSet = createSetter(false, true);\n\nexport const mutableHandler = {\n  get,\n  set,\n};\nexport const shallowMutableHandler = {\n  get: shallowGet,\n  set: shallowSet,\n};\nconst readonlySet = {\n  set(target: object, key: string) {\n    console.warn(\n      `warning: Cannot set key '${key}' , source target is readonly`\n    );\n  },\n};\nexport const readonlyHandler = assign({ get: readonlyGet }, readonlySet);\nexport const shallowReadonlyHandler = assign(\n  { get: shallowReadonlyGet },\n  readonlySet\n);\n","import { isObject } from \"@vue/shared\";\nimport {\n  mutableHandler,\n  readonlyHandler,\n  shallowMutableHandler,\n  shallowReadonlyHandler,\n} from \"./baseHandler\";\n\nfunction reactive(target: object) {\n  return createReactiveObject(target, false, mutableHandler);\n}\n\nfunction shallowReactive(target: object) {\n  return createReactiveObject(target, false, shallowMutableHandler);\n}\n\nfunction readonly(target: object) {\n  return createReactiveObject(target, true, readonlyHandler);\n}\n\nfunction shallowReadonly(target: object) {\n  return createReactiveObject(target, true, shallowReadonlyHandler);\n}\n\n/**\n * weakMap 和 Map 的区别:\n * 1、Map 具有强引用，当我们将引用类型的 key 赋值为 null 时，它不会被垃圾回收，而是继续使用，所以会造成内存泄漏，\n * 而 weakMap 具有弱引用，当我们将引用类型的 key 赋值为 null 时, 会直接被垃圾回收。\n * 2、map 的 key 可以是任意类型的，而 weakMap 只能是 引用类型，不然会报错。\n * 3、由于 weakMap 具有弱引用，所以它没有 map 的 size，keys，values等 API。\n */\n\n// 响应式 map\nconst reactiveMap = new WeakMap();\n// 只读响应式 map\nconst readonlyMap = new WeakMap();\n// 创建响应式对象\n/**\n *\n * @param target 代理目标\n * @param isReadonly 是否是只读的\n * @param baseHandler 针对不同的方式创建不同的代理对象\n */\nconst createReactiveObject = (\n  target: object,\n  isReadonly: boolean,\n  baseHandler: any\n) => {\n  // 判断是否是对象，如果是，则执行下面语句，否则直接返回当前 target\n  if (!isObject(target)) return target;\n\n  // 从集合中获取当前对象\n  const existProxy = isReadonly\n    ? readonlyMap.get(target)\n    : reactiveMap.get(target);\n  // 判断当前属性是否代理过，如果是，则直接返回，否则就创建代理\n  if (existProxy) return existProxy;\n\n  // 创建代理\n  const proxy = new Proxy(target, baseHandler);\n\n  // 代理成功之后将当前代理存入 map 中\n  reactiveMap.set(target, proxy);\n  return proxy;\n};\n\nexport { reactive, shallowReactive, readonly, shallowReadonly };\n"],"names":[],"mappings":"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"}